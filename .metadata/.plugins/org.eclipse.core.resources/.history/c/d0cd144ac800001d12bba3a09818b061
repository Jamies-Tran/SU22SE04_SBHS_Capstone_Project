package com.swm.converter;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;

import com.swm.dto.BookingDto;
import com.swm.dto.HomestayAftercareDto;
import com.swm.entity.BookingEntity;
import com.swm.entity.HomestayAftercareEntity;
import com.swm.exception.ParseDateException;
import com.swm.service.IHomestayService;
import com.swm.service.IUserService;

@Component
public class BookingConverter {

	@Autowired
	@Lazy
	private IUserService userService;

	@Autowired
	@Lazy
	private IHomestayService homestayService;

	@Autowired
	private HomestayConverter homestayConvert;
	
	private SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd");

	public BookingEntity bookingToEntity(BookingDto bookingDto) {
		BookingEntity bookingEntity = new BookingEntity();
		bookingEntity.setBookingCreator(userService.findUserByUsername(bookingDto.getPassengerName()).getPassenger());
		bookingEntity.setBookingHomestay(homestayService.findHomestayByName(bookingDto.getHomestayName()));
		List<HomestayAftercareEntity> homestayServiceList = bookingDto.getHomestayServiceDto().stream()
				.map(s -> homestayConvert.homestayAftercareEntityConvert(s)).collect(Collectors.toList());
		bookingEntity.setHomestayServiceBooking(homestayServiceList);
		try {
			Date checkIn = simpleDateFormat.parse(bookingDto.getCheckIn());
			bookingEntity.setCheckIn(checkIn);
		} catch (ParseException e) {
			throw new ParseDateException(bookingDto.getCheckIn());
		}
		try {
			Date checkOut = simpleDateFormat.parse(bookingDto.getCheckOut());
			bookingEntity.setCheckOut(checkOut);
		} catch (ParseException e) {
			throw new ParseDateException(bookingDto.getCheckOut());
		}
		
		return bookingEntity;
	}
}
